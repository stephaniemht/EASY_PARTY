<div class="container-show">
  <div class="item link">
    <img src="" alt="">
    <h1><%= @event.name %></h1>
    <p>Lieu : <%= @event.address %></p>
    <p>Description : <%= @event.description %></p>


    <% if policy(@event).edit? %>
      <%= link_to 'Modifier', edit_event_path(@event), class: 'btn btn-primary' %>
    <% end %>

    <%= link_to 'Supprimer', event_path(@event), data: { turbo_method: :delete, turbo_confirm: 'Etes vous s√ªr ?' }, class: 'btn btn-danger' if policy(@event).destroy? %>
    <%= link_to 'Retour √† la liste', events_path, class: 'btn btn-primary' %>
    <% if policy(@event).duplicate? %>
      <%= link_to "Dupliquer l'√©v√©nement", duplicate_index_path(@event), class: "btn btn-secondary", data: { confirm: "√ätes-vous s√ªr de vouloir dupliquer cet √©v√©nement ?" } %>
    <% end %>
  </div>

  <div class="item">
    <h2>Dates propos√©es</h2>
    <% if @event.event_dates.any? %>
    <% @event.event_registered_users.where(status: ["En attente", "Accept√©"]).each do |registration| %>
        <strong><%= registration.user.first_name %></strong>
          <% if registration.user.photo.attached? %>
              <%= cl_image_tag registration.user.photo.key, class: "avatar-invit√©" %>
          <% else %>
              <img src="https://www.shutterstock.com/image-vector/default-avatar-profile-icon-vector-600nw-1725655669.jpg" alt="avatar-par-d√©faut" class="avatar-invit√©" >
            </a>
          <% end %>
    <% end %>

      <div data-controller="calendar-show" data-calendar-show-dates-value="<%=  @calendar_dates.to_json %>">
        <% @event.event_dates.each do |event_date| %>
          <div data-calendar-show-target="eventDate" class='d-none'>    <%= l(event_date.proposed_date, format: :long) %>

              <%= turbo_stream_from "event_dates_#{event_date.id}_votes" %>
                <div id="vote_<%= event_date.id %>" >
                  <%= render "vote", event_date: event_date %>
                </div>


                <% if event_date.votes.where(user: current_user).empty? %>
                  <%= button_to "Voter pour cette date", votes_path(event_date_id: event_date.id),
                                turbo_method: :post,
                                data: {event_date: event_date.proposed_date},
                                class: "btn btn-primary" %>
                <% else %>
                  <p class="text-success">Vous avez d√©j√† vot√© pour cette date.</p>
                <% end %>
           </div>
        <% end %>
      </div>
    <% else %>
      <div data-controller="calendar-show-fixed" data-calendar-show-fixed-date-value="<%= @event.date_fixed.to_json %>"></div>

    <% end %>
    </div>


  <div class="item">
    <%= form_with url: event_invitations_path(@event), method: :post, local: true do |f| %>
      <div class="form-group">
        <%= f.label :phone_number, "Envoyer une invitation par SMS" %>
        <%= f.telephone_field :phone_number, class: "form-control", required: true %>
      </div>
      <%= f.submit "Envoyer l'invitation", class: "btn btn-primary" %>
    <% end %>

    <h2 class="pt-5">Invit√©s</h2>
    <div class="avatar">
      <% @event.event_registered_users.where(status: ["En attente", "Accept√©"]).each do |registration| %>
          <strong><%= registration.user.first_name %></strong>
          <% if registration.user.photo.attached? %>
              <%= cl_image_tag registration.user.photo.key, class: "avatar-invit√©" %>
          <% else %>
              <img src="https://www.shutterstock.com/image-vector/default-avatar-profile-icon-vector-600nw-1725655669.jpg" alt="avatar-par-d√©faut" class="avatar">
          <% end %>
          <% if registration.user == current_user && registration.status == "En attente" %>
            <%= button_to "Accepter", accept_event_registered_user_path(registration), method: :patch, class: "btn btn-success" %>
            <%= button_to "Refuser", decline_event_registered_user_path(registration), method: :patch, class: "btn btn-danger" %>
          <% end %>
      <% end %>
    </div>
  </div>

  <div class="item">
    <div style="width: 100%; height: 600px;"
    data-controller="map"
    data-map-marker-value="<%= @marker.to_json %>"
    data-map-api-key-value="<%= ENV['MAPBOX_API_KEY'] %>"></div>
  </div>
  <div class="item">
    <% if @event.jackpot %>
      <h2>Cagnotte</h2>
      <p>L'organisateur se charge des courses, bande de fain√©ant ü¶•</p>
      <p><strong>Montant demand√© par personne :</strong> <%= @event.jackpot.amount_per_person %> ‚Ç¨</p>
      <p><strong>Total attendu :</strong> <%= @event.jackpot.amount_per_person * @event.jackpot.total_invitees %> ‚Ç¨</p>
      <p><strong>Montant collect√© :</strong> <%= @event.jackpot.total %> ‚Ç¨</p>
      <p><%= link_to 'Voir les participants', event_jackpot_path(@event, @event.jackpot), class: "btn btn-primary" %></p>

      <% if @event.jackpot %>
        <p>
          <%= link_to "Tu as pay√© ?", monney_creation_path(@event.jackpot),
                      data: { turbo_method: :post, turbo_confirm: "Envoie la preuve ! Mito" },
                      class: 'btn btn-primary',
                      disabled: true %>
        </p>
      <% end %>
    <% else %>
      <h2>Votre liste de courses</h2>
        <%= turbo_frame_tag "items_frame" do %>
          <% if @event.items.present? %>
            <%= render partial: "items/list", locals: { items: @event.items } %>
          <% else %>
            <%= turbo_frame_tag "item_form" do %>
              <%= link_to "Ajouter un item", new_event_item_path(@event),
                          class: "btn btn-primary",
                          data: { turbo_frame: "item_form" } %>
            <% end %>
          <% end %>
        <% end %>
    <% end %>
  </div>

  <div class="link container-album">
    <div>
      <h3>Album de l'√©v√®nement</h3>
    </div>
    <div>
      <%= link_to "Voir l'Album", event_album_path(@event, @event.album), class: 'btn btn-primary' %>
    </div>
  </div>

</div>
